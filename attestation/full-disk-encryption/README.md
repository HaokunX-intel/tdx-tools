# Intel&reg; TDX Full Disk Encryption

Full disk encryption (FDE) is a security method for protecting sensitive
data by encrypting all data on a disk partition. FDE shall encrypt data
automatically to prevent unauthorized access.
This project is a FDE solution based on [Intel&reg; Trust Domain 
Extensions(Intel TDX)](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-trust-domain-extensions.html)
and [Project Amber](https://www.intel.com/content/www/us/en/security/project-amber.html).

## Architecture

![](./docs/fde-arch.png)

### The fde-agent

In the early-boot stage, `fde-agent` which resides in the `initramfs`, is launched by `init` to mount an encrypted rootfs. The workflow of `fde-agent` can be partitioned in the four steps:

1. Retrieve the `secret` from the `efivar`.
    - the secret is enrolled in the OVMF previously
    - the secret is composed of three members: `url`, user token and certification, which will be used to retrieve the key from remote KBS (Key Broker Service)

2. Retrieve the quote and `keyid` 
    - the quote is the evidence proving that proves the TEE is secured from the hardware, it will be sent to the KBS
    - the `keyid` will be a part of the url to query the KBS
        - `keyid` is an uuid generated by a version 5 UUID generator in URL namespace, with a parameter named by `mrownerconfig` passed through the `QEMU` 
        - details about uuid can be found in `src/quote.rs`, [crate uuid](https://github.com/uuid-rs/uuid) and [uuid namespace](https://www.rfc-editor.org/rfc/rfc4122#section-4.3)
        - the method to pass the parameter `mrownerconfig` is shown in the `Test` section of the page

3. Retrieve the `key` encrypting the encrypted rootfs from the KBS.
    - the entire url looks like: `https://${url}/kbs/v1/keys/${keyid}/transfer`
    - `${url}` is retrieved in the step 1
    - `${keyid}` is retrieved in the step 2

4. Decrypt the encrypted filesystem by `${key}` and mounted as the guest rootfs
    - the `${key}` is retrieve in the step 3

## Build

For convenience, the `FDE_DIR` will represent the directory `full-disk-encryption` in the following parts.

### Prerequisite

1. The fde-agent depends on libraries in the [SGXDataCenterAttestationPrimitives](https://github.com/intel/SGXDataCenterAttestationPrimitives.git) from tag `tdx_1.5_dcap_mvp_23q1`. 

Make sure the submodules have been initialized and switch to the correct tags.

```
git submodule update --init
```

2. Build two libraries: libqgs_msg.a and libtdx_attest.so

The dependent rust crates `tdx-attest-rs` and `tdx-attest-sys` need to link these two libraries. Therefore we have to compile them.

```
cd ${FDE_DIR}

make -C SGXDataCenterAttestationPrimitives/QuoteGeneration/quote_wrapper/qgs_msg_lib/linux

make -C SGXDataCenterAttestationPrimitives/QuoteGeneration/quote_wrapper/tdx_attest/linux
```

3. The crate `tdx-attest-sys` need to find the header file `tdx-attest.h` to generate a binding file for rust. The header file `tdx-attest.h` is in directory `SGXDataCenterAttestationPrimitives/QuoteGeneration/quote_wrapper/tdx_attest`. There are two ways to help build scripts to find the `tdx-attest.h`
- copy the header file into the system header file searching path, such `/usr/include`
- redirect the header searching path to the local directory in the build scripts `SGXDataCenterAttestationPrimitives/QuoteGeneration/quote_wrapper/tdx-attest-sys/build.rs` to find the header file
    ```
    - let mut sdk_inc = String::from("-I");
    - match env::var("SGX_SDK") {
    -     Ok(val) => {
    -         sdk_inc.push_str(&val);
    -         sdk_inc.push_str("/include/");
    -     },
    -     _ => (),
    - }

    + let sdk_inc = String::from("-I../tdx_attest");

    ```
    
### Build FDE agent

Install [Rust-lang](https://www.rust-lang.org/), then build the FDE agent:

```
cargo build --release
```

Optional, strip for small-size application

```
strip --strip-all target/release/fde-agent
```


